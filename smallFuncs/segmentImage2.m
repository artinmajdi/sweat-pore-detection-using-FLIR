function [BW,maskedImage] = segmentImage2(X)
%segmentImage Segment image using auto-generated code from imageSegmenter app
%  [BW,MASKEDIMAGE] = segmentImage(X) segments image X using auto-generated
%  code from the imageSegmenter app. The final segmentation is returned in
%  BW, and a masked image is returned in MASKEDIMAGE.

% Auto-generated by imageSegmenter app on 10-May-2020
%----------------------------------------------------


% Adjust data to span data range.
X = imadjust(X);
gaborX = createGaborFeatures(X);

% Graph cut with texture
foregroundInd = [228 741 1253 1254 1766 2016 2060 2061 2063 2064 2069 2074 2077 2081 2086 2089 2093 2095 2099 2104 2107 2109 2113 2115 2118 2121 2126 2128 2132 2134 2137 2140 2144 2146 2151 2156 2159 2162 2166 2170 2172 2177 2179 2181 2569 2570 2694 2791 3206 3552 3592 4230 4616 4741 5253 5640 5765 6788 7812 8161 8324 9226 9859 10370 11394 11740 12298 12417 13440 14307 14975 15372 15999 16510 17533 18393 18556 18915 19417 19579 20091 20952 21625 21976 22029 22488 23000 23160 24024 24183 25048 25206 25572 25614 26072 26740 28120 28644 28786 29199 29809 30680 30831 31760 33240 33389 33899 34321 34788 35945 36312 37991 39383 39526 39955 40406 41060 41444 42454 42593 43104 44639 45661 46038 47125 47196 47707 48728 49622 49636 50264 51284 51286 52247 52308 53330 53718 53841 54352 55766 55780 55886 56908 58391 58442 58838 59977 60439 60998 61398 62487 62532 62934 62998 63972 64022 64067 65557 65601 66006 66581 66623 68054 68117 68156 68580 69653 69690 70101 70675 71224 71637 72210 72660 72758 73746 73780 74196 74724 74768 75315 75731 75825 76303 76336 77359 77778 77869 78308 78863 78892 79314 79403 79913 80337 80399 80423 80424 81422 81873 81957 82446 82467 83409 83470 83489 83982 84000 84494 85006 85007 85019 85021 85457 86040 86481 86499 86550 87570 89041 90577 92624 94689 95184 97744 100304 101840 102366 104912 107472 107486 109520 112592 113116 116176 117200 118745 119256 119767 120277 120279 120284 121298 121299 121300 121809 122317 122319 122820 122825 123315 123344 123835 123838 125904 126428 126928 128464 130524 131024 133583 133596 135631 138190 138204 140238 142286 143310 143324 145358 146382 146397 147406 149454 150990 151006 152014 154062 154079 155086 156622 157646 158670 158688 160718 162272 163278 164832 165326 166862 166880 168398 168928 169440 170446 171982 173518 174560 175566 176590 176608 177614 180174 180192 181710 182752 183246 184270 184288 185806 187854 188384 189390 191438 192480 193998 195551 196046 198094 198111 199630 200654 201183 202190 203214 203742 205774 207822 207838 209374 210382 211918 212446 213454 213982 216014 216542 217550 219086 220622 220638 221646 222158 223198 223694 224718 226254 226270 227790 229838 230366 231374 232910 234462 234958 235982 238542 238558 240590 242126 244190 244686 247758 247774 249806 249821 251356 253902 253916 256987 257998 260058 261070 262618 263118 264142 265690 266702 269785 270798 272345 274894 276953 278990 280025 280526 283097 283598 285144 286670 288727 289230 291798 292814 293334 295374 295892 297422 298452 299982 300500 301523 302034 302545 303054 303057 304081 304592 305104 305616 306110 306127 306621 306623 306638 306639 307135 307150 307648 307662 308160 308253 308256 308259 308263 308265 308268 308664 308672 308762 308782 308784 308787 309184 309198 309268 309270 309272 309303 309305 309310 309684 309686 309696 309824 309827 309830 309832 309835 309838 309844 309849 309852 309856 309857 309861 309863 309866 309868 309871 309874 309877 309881 309885 310208 310222 310403 310406 310410 310412 310706 310928 310930 310934 310938 310941 311216 311232 311245 311246 311313 311458 311460 311463 311466 311727 311757 311981 311986 311988 311991 311993 311997 312236 312256 312269 312510 312513 312515 312518 312746 312768 313031 313033 313255 313280 313293 313294 313548 313762 313763 313792 313805 314062 314304 314317 314577 314781 315090 315092 315094 315096 315097 315287 315290 315328 315341 315797 315853 315920 315921 316123 316308 316434 316637 316638 316641 316816 316818 316863 316946 317155 317458 317460 317668 317670 317824 317826 317829 317830 317832 317835 317837 317886 317902 318183 318184 318185 318332 318334 318485 318697 318836 318838 318839 318840 318842 318910 318997 318999 319209 319210 319340 319343 319345 319346 319512 319847 319848 319849 319851 319852 319934 320025 320234 320354 320356 320357 320538 320541 320746 320830 320832 320833 320835 320837 320838 320841 320843 320844 320846 320848 320849 320852 320854 320856 320857 320859 320861 320862 320865 320956 321055 321258 321341 321467 321569 321572 321769 321770 321772 321774 321777 321779 321780 321782 321783 321786 321788 321790 321792 321794 321797 321798 321799 321801 321802 321804 321805 321807 321810 321812 321814 321816 321819 321821 321824 321827 321829 321831 321832 321834 321835 321837 321840 321843 321846 321848 321850 321851 321998 322088 322091 322216 322222 322227 322230 322232 322236 322240 322243 322246 322251 322254 322260 322262 322267 322269 322272 322274 322277 322278 322279 322280 322281 322490 322609 322719 322724 322793 323125 323131 323137 323142 323150 323156 323162 323166 323172 323176 323180 323184 323188 323193 323199 323203 323210 323215 323223 323309 323313 323403 323407 323410 323413 323416 323420 323425 323427 323431 323436 323439 323443 323444 323449 323459 323507 323510 323512 323829 323834 323838 323839 323842 323844 323846 323848 323850 323853 323856 323861 323864 323867 323873 323880 323883 323889 323894 323900 323906 323909 323912 323977 324018 324492 324493 324528 325012 325015 325019 325023 325025 325029 325030 325033 325034 325036 325037 325070 326606 ];
backgroundInd = [442 445 958 1978 1982 3002 3007 4031 4377 4381 4386 4389 4392 4396 4400 4405 4410 4414 4417 4422 4427 4431 4438 4446 4452 4538 4543 4790 4792 4795 4797 4800 4803 4804 4807 4973 5298 5300 5322 5324 5397 5492 5562 5567 5807 5808 5904 6011 6017 6019 6023 6028 6030 6034 6038 6040 6042 6044 6079 6351 6558 6560 6829 6926 7074 7075 7098 7103 7379 7435 7610 8101 8127 8363 8404 8613 8634 8639 8874 8969 9658 9663 9896 9944 9990 10151 10175 10682 10687 10919 11175 11199 11525 11706 11711 12200 12218 12223 12454 12508 12546 12730 12735 13247 13569 13737 13989 14271 14592 15011 15073 15103 15275 15290 16098 16126 16320 16812 17058 17125 17148 17638 17850 17856 18152 18155 18167 18170 18368 18671 18673 18677 18874 19616 19905 20398 20409 20417 20929 21151 21432 21953 22456 22465 22968 22977 23709 23983 24001 24513 25025 25538 26267 27802 28081 30360 30642 33429 33715 35476 37521 37813 40079 42637 42935 44682 44984 46729 48263 49057 49570 50082 50107 50591 50595 50821 51107 51614 52131 52649 53163 53377 53667 54684 54691 54701 54716 55423 55725 56228 57262 57764 57775 58301 58492 58800 59301 59824 60026 61049 61338 61360 61373 62373 62384 62896 63607 64432 64944 65142 65957 66494 66993 67188 68005 68514 68515 68516 68529 68722 69530 69541 70080 70568 70577 70767 71075 71081 71089 71593 72113 72128 72301 72613 72618 72619 73324 73649 74156 74176 74346 74648 74661 75369 75683 75694 75697 75712 76391 76736 77744 77745 78243 78272 78436 78757 79256 79281 79457 79792 80320 80817 81503 81840 82327 82337 82352 82368 82852 82864 83037 83888 84569 84912 85398 85424 85591 85936 85952 86422 86430 86448 86612 86947 87472 87634 87958 88471 88987 89008 89024 89166 89496 89498 90019 90032 90697 91043 91056 91072 91717 92081 92593 93246 93617 93618 93632 94129 94130 94627 94779 95680 95798 96704 96819 97215 97698 98750 98861 99877 100385 100798 101792 101820 101909 101910 101911 101912 101913 102331 102421 102933 103355 103445 104469 104889 104981 105493 105912 106517 106935 107541 108468 108565 108976 109589 110508 111544 111545 111637 112055 112056 112551 112566 112661 113077 113078 113587 113588 114083 114098 114099 114608 114609 115117 115118 115120 115627 115733 116136 116139 116637 116757 117147 117156 117158 117659 118172 118178 118685 118687 119191 119197 119317 119708 119709 120223 120724 120735 120853 121746 121760 122389 122785 122786 123811 124303 124323 124437 124836 125839 125861 125862 126351 126374 126485 126863 126886 127399 127509 127887 127912 128399 128936 129045 129961 130070 130474 130987 131474 131499 131606 132012 132501 132524 132630 133036 133037 133549 133654 134062 134552 134576 135190 135601 136090 136114 136214 136627 137140 137629 137652 137750 138166 139169 139191 139798 140217 141220 141243 141757 142246 142270 142782 142870 143806 144808 144831 145343 145843 145845 145846 146358 146367 146454 146870 146879 147382 147883 147894 147903 148406 148415 148918 149430 149439 150444 150454 150463 150550 150966 150975 151478 151990 153535 154559 155054 156182 157090 157103 157119 157602 158112 158114 159136 159137 159167 160160 160669 160703 161184 161200 161302 161695 161727 163230 163248 163263 163738 163742 164374 165278 166300 166301 166335 166807 166832 167323 167324 167958 168383 168853 169392 171455 173589 174015 174512 175551 177072 177599 178196 180159 181183 181680 182206 183230 183314 184752 185278 186814 189455 190384 190910 195087 197054 198064 199614 200207 201114 201117 201121 201150 201637 201639 202155 202160 203185 203702 205243 205839 206782 207280 207806 207809 209342 209345 209858 210864 210877 210882 210959 211394 211906 212413 212418 212912 213442 213948 214972 214978 215490 216002 216508 216514 217520 217532 217538 218044 219074 219568 219580 220098 220175 220610 221628 221634 222658 223152 223682 224270 224706 225212 225218 226242 227248 227266 227772 227778 228802 229314 229901 230320 230338 231362 231874 232380 232897 233409 233904 234433 235457 235969 236481 236555 236976 236988 236993 238017 238529 239036 239536 239552 240576 241162 241596 241600 242112 242608 242620 242624 243136 244143 244156 244672 246204 246794 247232 248252 248749 248767 249788 250890 251326 252332 252348 252862 253451 254396 254910 254987 255403 256956 256958 257549 257960 257980 259515 259518 261054 261542 261566 262160 262587 262590 264638 265123 265658 265749 266686 267680 267706 268222 269210 269246 270778 270782 272276 272318 272923 274319 275386 275902 276362 276414 277438 277537 278404 279935 279998 281468 281639 282042 283691 284204 284534 285231 285746 285747 285750 285755 285758 285761 285764 285766 285771 286803 286820 287346 287351 287363 287376 287389 287399 287408 287419 287429 287439 287446 287455 287465 287471 287480 287487 287495 287596 288014 288532 288538 289058 289127 290090 290092 290607 291166 291635 292155 292185 292673 292679 292683 292690 292787 295852 296360 296529 296530 296532 296533 296534 296535 296537 296540 296542 296544 296546 296548 296550 296552 296554 296557 296558 296559 296560 296562 296565 296567 296568 296571 296572 296574 296576 296579 296581 296583 296585 296587 296589 296591 296592 296594 296596 296597 296864 297021 297022 297025 297026 297029 297031 297034 297035 297038 297039 297111 297113 297114 297116 297117 297119 297120 297372 297525 297526 297528 297529 297531 297634 298029 298032 298035 298147 298148 298149 298539 298662 298664 298666 298900 299048 299049 299532 299533 299534 299535 299536 299537 299538 299539 299540 299541 299542 299544 299546 299548 299550 299552 299555 299556 299558 299691 299692 299695 300208 300210 300318 300427 300723 300724 301238 301239 301240 301242 301244 301246 301446 301758 301761 301763 301764 301766 301768 301770 301771 301774 301777 301778 301781 301782 301784 301786 301788 301789 301791 301792 301794 301856 302309 302311 302313 302315 302317 302319 302372 302833 302835 302975 303348 303863 303865 303917 303920 303986 303991 304379 304490 304522 304892 304894 304948 304996 305031 305407 305409 305468 305473 305482 305488 305490 305492 305494 305497 305499 305500 305502 305504 305507 305511 305516 305519 305521 305522 305524 305526 305527 305528 305530 305532 305533 305535 305538 305540 305923 305924 305926 305996 306439 306505 306952 306954 306956 306957 307006 307009 307011 307014 307442 307471 307515 307956 307957 307985 307987 307988 307990 307992 308022 308024 308471 308986 309032 309039 309043 309499 309501 309502 309503 309504 309544 309546 309547 309548 309549 310018 310051 310053 310056 310132 310530 310532 310533 310562 310573 311047 311049 311050 311052 311053 311055 311058 311060 311062 311064 311065 311067 311069 311070 311072 311088 311091 311094 311097 311099 311102 311104 311107 311110 311112 311113 311115 311117 311118 311120 311122 311124 311126 311129 311132 311133 311135 311137 311139 311141 311143 311145 311148 311151 ];
L = superpixels(X,2525);
BW = lazysnapping(gaborX,L,foregroundInd,backgroundInd);

% Create masked image.
maskedImage = X;
maskedImage(~BW) = 0;
end

function gaborFeatures = createGaborFeatures(im)

if size(im,3) == 3
    im = prepLab(im);
end

im = im2single(im);

imageSize = size(im);
numRows = imageSize(1);
numCols = imageSize(2);

wavelengthMin = 4/sqrt(2);
wavelengthMax = hypot(numRows,numCols);
n = floor(log2(wavelengthMax/wavelengthMin));
wavelength = 2.^(0:(n-2)) * wavelengthMin;

deltaTheta = 45;
orientation = 0:deltaTheta:(180-deltaTheta);

g = gabor(wavelength,orientation);
gabormag = imgaborfilt(im(:,:,1),g);

for i = 1:length(g)
    sigma = 0.5*g(i).Wavelength;
    K = 3;
    gabormag(:,:,i) = imgaussfilt(gabormag(:,:,i),K*sigma);
end

% Increases liklihood that neighboring pixels/subregions are segmented together
X = 1:numCols;
Y = 1:numRows;
[X,Y] = meshgrid(X,Y);
featureSet = cat(3,gabormag,X);
featureSet = cat(3,featureSet,Y);
featureSet = reshape(featureSet,numRows*numCols,[]);

% Normalize feature set
featureSet = featureSet - mean(featureSet);
featureSet = featureSet ./ std(featureSet);

gaborFeatures = reshape(featureSet,[numRows,numCols,size(featureSet,2)]);

% Add color/intensity into feature set
gaborFeatures = cat(3,gaborFeatures,im);

end

function out = prepLab(in)

% Convert L*a*b* image to range [0,1]
out = in;
out(:,:,1) = in(:,:,1) / 100;  % L range is [0 100].
out(:,:,2) = (in(:,:,2) + 86.1827) / 184.4170;  % a* range is [-86.1827,98.2343].
out(:,:,3) = (in(:,:,3) + 107.8602) / 202.3382;  % b* range is [-107.8602,94.4780].

end
